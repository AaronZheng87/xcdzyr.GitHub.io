<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src='jspsych-6.1.0/jspsych.js'></script>
    <script src='jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js'></script>
    <script src='jspsych-6.1.0/plugins/jspsych-survey-text.js'></script>
    <script src='jspsych-6.1.0/plugins/jspsych-html-button-response.js'></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-html-form.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css">
    </link>
    <script src="jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css">
    <script src="jspsych-6.1.0/plugins/jspsych-psychophysics.js"></script>
    <style>
        .add_{
            font-size: 25px;
        }

        body {
            background-color: grey;

        }
        .zfx {
            margin: 0 20px;
        }
        #jspsych-html-keyboard-response-stimulus {
            width: 600px;
            /* 中间盒子宽度 */
            min-height: 500px;
            /*中间盒子最小高度*/
            display: flex;
            /*设置弹性盒布局ee*/
            flex-direction: column;
            /*设置弹性盒为纵向的布局*/
            align-items: center;
            /*垂直居中*/
            justify-content: space-around;
            /*弹性盒对象的 <div> 元素中的各项周围留有空白,并且是均分的,横向的*/
            position: relative;
            /*绝对定位 父元素相对定位*/
        }
        #aaa {
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            font-size: 30px !important;
            position: absolute;
            left: 50%;
            top: 50%;
            margin-left: -15px;
            margin-top: -15px;

        }
        .flex_body {
            display: flex;
            justify-content: center;
        }

    </style>
</head>
<body style="text-align:center;">
</body>
<script>
    let img = ["img/C.bmp", "img/P.bmp", "img/Tra.bmp"];
    let word = ["好人", "坏人", "常人"];

    let b = []; //stimulate null
    // let i1 = jsPsych.randomization.sampleWithoutReplacement(img, 3);
    let i1 = [img[0], img[2], img[1]];
    b.push({
        stimulus: i1[0],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: "m"
        }
    }, {
        stimulus: i1[0],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: "m"
        }
    }, {
        stimulus: i1[1],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: "n"
        }
    }, {
        stimulus: i1[2],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: "n"
        }
    }, {
        stimulus: i1[0],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: "n"
        }
    }, {
        stimulus: i1[1],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: "m"
        }
    }, {
        stimulus: i1[1],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: "m"
        }
    }, {
        stimulus: i1[2],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: "n"
        }
    }, {
        stimulus: i1[0],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: "n"
        }
    }, {
        stimulus: i1[1],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: "n"
        }
    }, {
        stimulus: i1[2],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: "m"
        }
    }, {
        stimulus: i1[2],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: "m"
        }
    });    console.log(b);
    let test_stimuli = jsPsych.randomization.sampleWithoutReplacement(b, b.length);

    let timeline = [];


    let error1 = {
        type: "html-keyboard-response",
        stimulus: "<p>错误次数过多，请按任意键重新进行实验～</p>",
        choices: jsPsych.ALL_KEYS
        // 判断是否错误过多
    };



    let enterFullscreenMode = {
        type: "fullscreen",
        fullscreen_mode: true,
        message: "<p style = 'color : white'>实验需要全屏模式</p>",
        button_label: "点击这里进入全屏"
    }; // 全屏指导



    let welcome = {
        type: "html-keyboard-response",
        stimulus:
            "<p style='font: bold 42px 华文楷体; color: #adff87'>\
           欢迎参与我们的实验</p>\
           <p style='font：30px S华文楷体; color: white'><br/>\
           <按任意键继续><br/><b>实验过程中请勿退出全屏</b>\
           <br/><br/></p>\
           <p style='font:24px 华文楷体; color: grey'>\
           <br/>2021年</p>",
        post_trial_gap: 100
    };

    let instr = {
        type: "instructions",
        pages: [
            "<p style= 'text-align: center; font-weight:700; font-size:25px; color : white'>知情同意书 </p><br/>\
             <p style='text-align: left; color : white'>\
             您在本研究中所提供的数据和样本未来可能会被其他研究项目使用。未来的这些项目也许会与本研究的问题相关，也有可能无关。通过互联网和完全公开的数据库，我们将完全共享本次研究中的数据，包括脑影像数据。<br/>\
             共享的数据中不会出现您的姓名，而仅以代号显示，所以他人不会获知您的姓名，也无法将数据与您进行对应。此外，我们也将对其他敏感信息进行保密，避免了解您的人通过某些信息猜测到哪些是您的数据。<br/><br/>\
             如果您改变主意并想将此同意书撤回（您可以通过拨打『某号码』致电『本研究的主要负责人PI XXXX』来执行此操作），我们将不会录入关于您的任何额外数据。如果您在数据被录入数据库之前申请撤回，您的数据将能够被及时删除。<strong>请注意，所有已经共享给其他研究者或公众的数据和研究结果将不能够再被销毁，退出或撤回。</strong><br/>\
             同意参与本研究，意味着您将给那些可能有助于人类的研究提供一份免费而慷慨的礼物。极有可能，使用您所共享数据的研究会开发出新的研究人脑的技术、新的诊断量表、新药物或其他产出。但是如果出现这些情况，您本人不会得到这些产品所带来的任何利润，也不会获得这些产品的任何所有权。<br/>\
         </p><p style= 'text-align:center; font-weight:700; font-size:15px; color : lightgreen'>同意请按“继续”并进入下一页 </p><br/>",
            "<p style= 'text-align: center; font-weight:700; font-size:25px; color : white'>知情同意书 </p><br/>\
                <p style='text-align: left; color : white'>\
                根据我们充分了解到的情况，<strong>我们向公众共享的数据中将不会包含能够直接识别出您身份的信息。**数据中没有您的名字、只有编码的数字，因此他人不会知道您的名字或者知道哪个数据是您。此外，数据中不会包括我们认为可能会让了解您的人猜测到哪个数据属于您的信息，比如您的面部特征或参与研究的日期等。如果我们就本研究撰写报告、文章，或者将本次研究的数据分享给他人，我们也将确保您不会被识别出来。</strong><br/>\
                根据我们充分了解到的情况，<strong>我们向公众共享的数据中将不会包含能够直接识别出您身份的信息。**数据中没有您的名字、只有编码的数字，因此他人不会知道您的名字或者知道哪个数据是您。此外，数据中不会包括我们认为可能会让了解您的人猜测到哪个数据属于您的信息，比如您的面部特征或参与研究的日期等。如果我们就本研究撰写报告、文章，或者将本次研究的数据分享给他人，我们也将确保您不会被识别出来。</strong><br/>\
                您数据的隐私部分（包括姓名，联系方式等）将至少被安全保存<X>年。这样的话，如果研究人员在您的脑部扫描数据中发现某些具有诊断价值的信息，我们能够与您取得联系。在该期限后，我们将会销毁这些信息以保护您的隐私。<br/>\
                <strong>是否让我们使用及分享您的数据将完全由您自愿决定。但是，参加本研究的前提是您愿意使用这种方式来分享您的数据。如果您不愿意，您将无法参加这项研究。</strong><br/>\
                如果您在下方签名，代表您同意向未来的研究共享您的数据，同意与来自世界各地研究机构的研究者共享您的数据。这些未来研究的细节、结果和应用均是未知的。<br/>\
                </p><p style= 'text-align:center; font-weight:700; font-size:15px; color : lightgreen'>同意请按“继续”进入实验 </p><br/>"

        ],
        show_clickable_nav: true,
        allow_backward: false,
        button_label_previous: "返回",
        button_label_next: "继续",
    };
    timeline.push(enterFullscreenMode,  welcome, instr); // 开头，数据收集

    let experinumber = {
        type:"survey-html-form",
        data:{
            varname:'experinumber',
        },

        preamble:"<p style =' color : white'>你的实验编号是</p>",
        html:"<p><input name='Q0' type='number' value='0001;' required/></p>",
        button_label:"继续",
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1
        }
    };
    let subjectnumber ={
        type:"survey-html-form",
        data:{
            varname:'subjectnumber',
        },
        preamble:"<p style = 'color : white'>你的编号是</p>",
        html:"<p><input name='Q0' type='number' value='0001' required/></p>",
        button_label:"继续",
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1
        }
    };
    let number_of_experiment ={
        type:"survey-html-form",
        data:{
            varname:'number_of_experiment',
        },

        preamble:"<p style = 'color : white'>你的实验次数是</p>",
        html:"<p><input name='Q0' type='number' value='1' required/></p>",
        button_label:"继续",
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1
        }

    };
    let sex = {
        type: 'html-button-response',
        data: {
            varname: 'sex'
        },
        stimulus: "<p style = 'color : white'>你的性别</p>",
        choices: ['男', '女', '其他'],
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1
        }
    };
    let birth = {
        type: 'survey-html-form',
        data: {
            varname: 'birth'
        },
        preamble: "<p style = 'color : white'>你的出生年</p>",
        html: `
    <p><input name="Q0" type="number" placeholder="1900~2020" min=1900 max=2020
    oninput="if(value.length>4) value=value.slice(0,4)" required /></p>`,
        button_label: '继续',
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1
        }
    };
    let education = {
        type: 'survey-html-form',
        data: {
            varname: 'education'
        },
        preamble: "<p style = 'color : white'>教育经历</p>",
        html: `
       <p><select name="Q0" size=10>
       <option>小学以下</option>
       <option>小学</option>
       <option>初中</option>
       <option>高中</option>
       <option>大学</option>
       <option>硕士</option>
       <option>博士</option>
       <option>其他</option>
       </select></p>`,
        button_label: '继续',
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1;
            let bodyNode = document.getElementsByTagName("body");
            for (let i = 0; i < bodyNode.length; i++) {
                bodyNode[i].style.cursor = "none";}

        }
    };
    timeline.push(experinumber, subjectnumber, number_of_experiment, sex, birth, education); // 信息收集


    let instructions1 = {
        type: "html-keyboard-response",
        stimulus: "<p style= 'text-align: center; font-weight:700; font-size:25px; color : white'>请您记住如下联结:</p>" +
            "<p style= 'text-align: center; font-weight:700; font-size:25px; color : white'>好人---五边形</p>" +
            "<p style= 'text-align: center; font-weight:700; font-size:25px; color : white'>坏人---圆形</p>"+
            "<p style= 'text-align: center; font-weight:700; font-size:25px; color : white'>常人---梯形</p>" +
            "<p style= 'text-align: center; font-weight:700; font-size:25px; color : white'>您需要通过练习来学习这些对应关系；接下来，如果屏幕上出现的图形和文字符合上述关系，请按“M”键；如果图形与文字不符合上述的关系，请按“N”键。请您又快又准地进行反应</p>"+
            "<p style = 'color : lightgreen'>按任意键开始实验</p><div>",
        post_trial_gap: 2000
    };

    let feedback_trial = {
        data: {
            screen_id: "feedback"
        },
        type: "html-keyboard-response",
        stimulus: function () {
            let key = jsPsych.data.get().last(1).values()[0].key_press;
            let last_trial_accuracy = jsPsych.data.get().last(1).values()[0].correct;
            let time = jsPsych.data.get().last(1).values()[0].rt;
            if (last_trial_accuracy && key) {
                return "<span class='add_' style='color: #adff87;'> correct! </span>"
            } else if (!key) {
                return "<span class='add_' style='color: yellow;'> Too slow! </span>"
            } else {
                return "<span class='add_' style='color: red;'> incorrect! </span>"
            }
        },
        choices: jsPsych.NO_KEYS,
        trial_duration: 300
    };

    let plus1 = {
        type: "psychophysics",
        stimuli: [
            {
                obj_type: 'cross',
                startX: "center", // location of the cross's center in the canvas
                startY: "center",
                line_length: 30,
                line_width:5,
                line_color: 'black', // You can use the HTML color name instead of the HEX color.
                show_start_time: 500,
                show_end_time: 1100// ms after the start of the trial

            },
            {
                obj_type: 'image',
                file: jsPsych.timelineVariable("stimulus"),
                startX: "center", // location of the cross's center in the canvas
                startY: 350,
                show_start_time: 1000, // ms after the start of the trial
                show_end_time: 1100,
            },
            {
                obj_type: 'text',
                startX: "center",
                startY: 550,
                content: jsPsych.timelineVariable("item"),
                font: "50px 'Arial'",
                text_color: 'white',
                show_start_time: 1000, // ms after the start of the trial
                show_end_time: 1100
            }
        ],
        choices: ["m", "n"],
        canvas_height:900,
        response_start_time: 1000,
        data: function () {
            let t = jsPsych.timelineVariable("stimulus", true);
            let w = jsPsych.timelineVariable("item", true);
            let key = jsPsych.timelineVariable("data", true);
            return {
                shape: t,//刺激类型
                word: w,//words
                key: key.correct_response,
                test_part: key.test_part + frequency
            }
        },
        on_finish: function (data) {
            data.correct = data.key === jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press);
        },
        trial_duration: 2200,
        background_color: "grey"
    };

    let frequency = 0;
    let trial1 = {
        timeline: [
            plus1,
            feedback_trial
        ],
        timeline_variables: test_stimuli,
        randomize_order: true,
        loop_function: function () {
            let accuracy = jsPsych.data.get().filter({correct: true, test_part: "test" + frequency}).count() / jsPsych.data.get().filter({test_part: "test" + frequency}).count();
            console.log(accuracy);
            frequency += 1;
            if (accuracy <= 0.5 && frequency<=1) {
                return true;
            } else if (accuracy >= 0.5 && frequency >=2) {
                jsPsych.pauseExperiment();
                jsPsych.addNodeToEndOfTimeline({
                    timeline: [feedback_all, rest, trial2]
                }, jsPsych.resumeExperiment);
            } else {
                jsPsych.pauseExperiment();
                jsPsych.addNodeToEndOfTimeline({
                    timeline: [feedback_all, error1,instructions1, trial1]
                }, jsPsych.resumeExperiment);
            }
        }
    };
    timeline.push(instructions1, trial1); // 练习阶段

    let feedback_all = {
        type: "html-keyboard-response",
        stimulus: function () {
            frequency -= 1;
            let trials = jsPsych.data.get().filter({
                test_part: 'test' + frequency
            });
            let correct_trials = trials.filter({
                correct: true
            });
            let accuracy = Math.round(correct_trials.count() / trials.count() * 100);
            let rt = Math.round(correct_trials.select('rt').mean());
            frequency += 1;
            return "<p>You responded correctly on " + accuracy + "% of the trials.</p>" +
                "<p>Your average response time was " + rt + "ms.</p>" +
                "<p>Press any key to complete the experiment. Thank you!</p>";
        }
    }; // 练习结束反馈阶段

    let rest = {
        type: "html-keyboard-response",
        stimulus: "<p style = 'color : white'>按任意键开始正式实验</p><div>",
        post_trial_gap:2000

    } // 休息阶段

    let instructions2 = {
        type: "html-keyboard-response",
        stimulus: "<p>请您记住如下联结:</p>" +
            "<p>好人---五边形</p>" +
            "<p>坏人---圆形</p>"+
            "<p>常人---梯形</p>" ,
        post_trial_gap: 2000
    };

    let trial2 = {
        timeline: [plus1,feedback_trial],
        timeline_variables: test_stimuli,
        randomize_order: true,
        repetitions: 4
    };//正式实验

    jsPsych.init({
        timeline: timeline,
        preload_images: ["img/P.bmp", "img/C.bmp", "img/Tra.bmp"],
        on_finish: function () {
            document.getElementById("jspsych-content").innerHTML = "<div><p style = 'color : white'>实验结束，非常感谢您的参与！</p >" +
                "<p>如果您对实验结果感兴趣，可以发邮件与我联系。</p >" +
                "<p>郑元瑞（Email: aaronzheng87@gmail.com） </p ></div>";
            jsPsych.data.get().localSave('csv', 'data.csv');
            document.exitFullscreen();
            let bodyNode = document.getElementsByTagName("body");
            for (let i = 0; i < bodyNode.length; i++) {
                bodyNode[i].style.cursor = "default";
                setTimeout(function(){
                    window.close();
                },5000)

            }
        }
    })

</script>
</html>